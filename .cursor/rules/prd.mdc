---
description:
globs:
alwaysApply: true
---
<!-- cursor-pattern: **/* -->
# Product Requirements: Digital Business Card

This rule enforces the functional requirements for the Digital Business Card website. All features and implementations must align with the following user stories and expected outcomes:

| Requirement ID | Description | User Story | Expected Behavior/Outcome |
|----------------|-------------|------------|--------------------------|
| FR001 | Card Backside & Social Profile | As a user, I want to flip the business card to see the back, which shows my profile, links, QR code, and social icons. | The system should allow flipping the card to reveal a profile page with avatar, name, description, main links, QR code, and social icons, styled as a modern digital profile card. The QR code button should replace the backside content with a large QR code image. The QR code content (URL) should be user-definable, but is not implemented yet. |
| FR002 | Comprehensive Shopping List Management | As a user, I want to view and manage all my shopping data (grocery lists, receipts from different stores) in one unified interface. | The system should provide a single page (`/shoplist`) that consolidates all shopping-related data including grocery lists, Woolworths receipts, and PAK'nSAVE receipts. Store names should be clearly distinguished with color-coded tags, and all data should be exportable as CSV. |
| FR003 | Image Style Transfer and Management | As a user, I want to generate different style variations of images and manage them efficiently. | The system should process uploaded images, generate style variations using AI/image processing, and store results in R2 storage with proper metadata. |
| FR004 | Rating and Feedback System | As a user, I want to rate and provide feedback on images and generated content. | The system should allow 1-5 star ratings, comments, and aggregate feedback statistics for quality improvement. |
| FR005 | Image Storage and Management Dashboard | As a user, I want a modern dashboard to upload, view, search, and manage all my images with statistics. | The system should provide a comprehensive image management interface with drag-and-drop upload, grid/list view, search functionality, batch operations, and detailed statistics. |
| FR006 | Image-to-Image (I2I) Transformation | As a user, I want to transform images using AI-powered style transfer and artistic filters. | The system should provide I2I transformation capabilities that can convert uploaded images into different artistic styles using Google AI/Imagen APIs with iterative improvement through self-correction loops. |
| FR007 | AI-Powered Image Description | As a user, I want the system to automatically generate detailed descriptions of my images. | The system should use AI models to analyze uploaded images and generate descriptive text that can be used for accessibility, cataloging, or prompt improvement. |
| FR008 | Iterative Image Improvement | As a user, I want the system to automatically improve image generation through multiple iterations. | The system should implement a self-correction loop: generate image â†’ describe result â†’ evaluate quality â†’ improve prompt â†’ regenerate, until satisfactory results are achieved. |
| FR009 | Dual-Model Cost Optimization | As a user, I want the system to optimize costs by using appropriate AI models for different tasks. | The system should use a dual-model approach: expensive paid models for image generation, free models for description and evaluation tasks. |
| FR010 | Secure API Key Management | As an admin, I want to securely store and manage AI API keys with encryption. | The system should provide an admin interface to store encrypted Google AI API keys, with password-protected access and automatic fallback between primary/secondary keys. |

**Detailed Rules for Card Flip & Backside (FR001):**
- The card must support a 3D flip animation (click or tap to flip between front and back).
- The backside must include:
  - A circular avatar at the top
  - User name and a short description
  - At least four main action buttons (e.g., channel, blog, outfits, affiliate links)
  - A row of social media icons (e.g., Twitter, Facebook, Instagram, Spotify)
  - A visible QR code (for sharing contact or profile info)
  - A visually appealing gradient background and rounded corners
- All elements must be responsive and accessible (keyboard/tab navigation, aria-labels)
- The QR code should be generated dynamically based on the user's profile or contact link
- The design should closely match the provided reference image for layout and style

**Detailed Rules for Shopping List Management (FR002):**
- All shopping data must be consolidated into a single page (`/shoplist`) accessible via direct URL (hidden from business card UI)
- Store identification must use color-coded tags in the first table column:
  - ðŸ”µ Jadan è¶…å¸‚ (Blue)
  - ðŸŸ¢ Woolworths (Green)
  - ðŸ”´ PAK'nSAVE (Red)
- Data should include:
  - Original grocery shopping list (19 items from Jadan + Woolworths)
  - Woolworths Mt Eden receipt (14 items)
  - PAK'nSAVE Royal Oak receipt (12 items)
- Summary statistics must show total items count and dual currency totals (NZD/TWD)
- CSV export functionality must include all consolidated data
- Page must use purple-pink gradient theme with responsive design
- Shopping list link is HIDDEN from business card navigation (not visible in UI)

**Implementation Notes:**
- **Path Change:** Updated from `/grocery-list` to `/shoplist` for shorter URL
- **UI Change:** Removed shopping list link from business card backside (hidden from user interface)
- Removed separate `/woolworths-receipt` and `/paknsave-receipt` pages (consolidated into `/shoplist`)
- Shopping list page accessible via direct URL navigation only
- Fixed ESLint issues with apostrophes using HTML entities (&apos;)
- Removed back navigation link from shopping list page for cleaner interface

**Image Style Processing Requirements (FR003):**
- Support multiple image formats (JPG, PNG, WebP)
- Generate style variations based on existing /slideswipe implementation
- Store original and processed images in R2 buckets
- Implement proper image optimization and compression
- Track processing history and metadata
- Support batch processing for multiple images
- Implement proper error handling for processing failures

**Rating and Feedback System Requirements (FR004):**
- Support 1-5 star ratings for images and generated content
- Allow users to leave comments and feedback
- Prevent duplicate ratings per user per image
- Display aggregate statistics (average rating, total ratings)
- Show rating distribution (number of 1-star, 2-star, etc.)
- Support sorting and filtering by rating
- Store all ratings in D1 database with proper indexing

**API Integration Requirements:**
- All endpoints must return consistent JSON responses with success/error status
- Implement proper CORS handling for frontend integration
- Use Zod for request/response validation
- Implement rate limiting and authentication where needed
- Support pagination for list endpoints
- Implement proper caching strategies using KV store
- Follow Cloudflare Workers best practices for performance

**Detailed Rules for I2I (Image-to-Image) System (FR006-FR010):**
- I2I transformation must support multiple image formats (JPG, PNG, WebP)
- System must implement iterative improvement loop with configurable max iterations (default: 3)
- Image generation must use Google Imagen API with fallback mechanisms
- Description and evaluation must use Google Gemini models (cost-optimized)
- All generated images must be stored in Cloudflare R2 with proper metadata
- Image metadata must include: original_url, transformation_prompt, iteration_count, model_used, generation_timestamp
- API keys must be encrypted using AES-256 and stored in Cloudflare D1 database
- Admin interface must require password authentication for key management
- System must support primary/secondary API key fallback for reliability
- Rate limiting must be implemented to prevent API abuse (10 requests per minute default)
- All I2I operations must be logged for debugging and cost tracking
- File naming convention: `i2i_success_YYYYMMDD_HHMMSS_xxxx.png`
- Error handling must include retry logic with exponential backoff
- Processing status must be tracked and accessible via API
- System must support batch processing for multiple images

**I2I API Endpoints:**
- `POST /api/i2i/transform` - Transform image with iterative improvement
- `GET /api/admin/keys/status` - Check API key configuration status
- `POST /api/admin/keys` - Store/update encrypted API keys (admin only)
- `GET /api/admin/keys` - Retrieve API key status (admin only)

**I2I Workflow:**
1. User uploads image via multipart/form-data
2. System validates image format and size
3. Initial transformation using provided prompt
4. AI describes generated image
5. AI evaluates quality and suggests improvements
6. If quality insufficient, improve prompt and regenerate (max 3 iterations)
7. Store final result in R2 and metadata in D1
8. Return transformed image URL and processing details

**Current URL Structure:**
- `/` - Main business card with flip animation
- `/slideswipe` - Image style processing interface
- `/shoplist` - Hidden comprehensive shopping list (not linked from UI)
- `/dashboard` - Modern image management dashboard with upload, view, and statistics
- `/admin/keys` - Admin interface for API key management (password protected)
- `/shorts` - Shorts content page

**API Endpoints:**
- `/api/uploads/*` - Image upload and management endpoints
- `/api/i2i/*` - I2I transformation API endpoints
- `/api/admin/*` - Admin API endpoints
- `/api/ratings/*` - Rating and feedback endpoints

**All implementations must fulfill these requirements. If a feature or code does not align with these, it should be revised.**
